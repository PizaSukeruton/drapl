<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple OBD2 Scanner</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            margin: 0;
        }
        
        h1 {
            color: #0f0;
            font-size: 20px;
        }
        
        button {
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        
        button:hover {
            background: #0f0;
            color: #000;
        }
        
        #console {
            background: #111;
            border: 1px solid #0f0;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        
        .command {
            color: #ff0;
        }
        
        .response {
            color: #0ff;
        }
        
        .error {
            color: #f00;
        }
    </style>
</head>
<body>
    <h1>OBD2 Scanner - 2011 Landcruiser 76</h1>
    
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <button onclick="testHandshake()">Test Handshake</button>
    <button onclick="scanAll()">Scan All PIDs</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="console"></div>

    <script>
        let port = null;
        let reader = null;
        let writer = null;

        function log(msg, type = '') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function clearLog() {
            document.getElementById('console').innerHTML = '';
        }

        async function connect() {
            try {
                log('Requesting serial port...');
                port = await navigator.serial.requestPort();
                
                log('Opening port at 38400 baud...');
                await port.open({ baudRate: 38400 });

                const encoder = new TextEncoderStream();
                encoder.readable.pipeTo(port.writable);
                writer = encoder.writable.getWriter();

                const decoder = new TextDecoderStream();
                port.readable.pipeTo(decoder.writable);
                reader = decoder.readable.getReader();

                log('Connected!', 'response');
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
            }
        }

        async function disconnect() {
            if (reader) reader.cancel();
            if (writer) writer.close();
            if (port) port.close();
            log('Disconnected', 'error');
        }

        async function send(cmd) {
            if (!writer) {
                log('Not connected!', 'error');
                return null;
            }

            log(`SEND: ${cmd}`, 'command');
            await writer.write(cmd + '\r');
            
            // Read response
            let response = '';
            let timeout = setTimeout(() => {}, 3000);
            
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    response += value;
                    
                    if (response.includes('>')) {
                        clearTimeout(timeout);
                        response = response.replace(/>/g, '').trim();
                        log(`RECV: ${response}`, 'response');
                        return response;
                    }
                }
            } catch (e) {
                clearTimeout(timeout);
                log(`Read error: ${e.message}`, 'error');
                return null;
            }
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function testHandshake() {
            log('\n=== STARTING HANDSHAKE ===\n');
            
            // Reset
            await send('ATZ');
            await sleep(2000);
            
            // Get version
            await send('ATI');
            await sleep(100);
            
            // Echo off
            await send('ATE0');
            await sleep(100);
            
            // Line feeds off
            await send('ATL0');
            await sleep(100);
            
            // Set protocol auto
            await send('ATSP0');
            await sleep(100);
            
            // Test communication
            await send('0100');
            await sleep(100);
            
            // Get protocol
            await send('ATDP');
            
            log('\n=== HANDSHAKE COMPLETE ===\n');
        }

        async function scanAll() {
            log('\n=== SCANNING ALL STANDARD PIDS ===\n');
            
            // Common PIDs to test
            const pids = [
                ['0100', 'Supported PIDs 01-20'],
                ['0101', 'Monitor Status'],
                ['0103', 'Fuel System Status'],
                ['0104', 'Engine Load'],
                ['0105', 'Coolant Temperature'],
                ['0106', 'Short Term Fuel Trim B1'],
                ['0107', 'Long Term Fuel Trim B1'],
                ['010B', 'Intake Manifold Pressure'],
                ['010C', 'Engine RPM'],
                ['010D', 'Vehicle Speed'],
                ['010E', 'Timing Advance'],
                ['010F', 'Intake Air Temperature'],
                ['0110', 'MAF Air Flow'],
                ['0111', 'Throttle Position'],
                ['0113', 'O2 Sensors Present'],
                ['011C', 'OBD Standard'],
                ['011F', 'Runtime Since Start'],
                ['0121', 'Distance with MIL'],
                ['0123', 'Fuel Rail Pressure'],
                ['012F', 'Fuel Level'],
                ['0130', 'Warm-ups Since Clear'],
                ['0131', 'Distance Since Clear'],
                ['0133', 'Barometric Pressure'],
                ['0142', 'Control Module Voltage'],
                ['0143', 'Absolute Load'],
                ['015C', 'Engine Oil Temperature'],
                ['015E', 'Fuel Rate'],
                ['0902', 'VIN']
            ];

            for (const [pid, desc] of pids) {
                log(`\nTesting ${pid} - ${desc}:`);
                await send(pid);
                await sleep(200);
            }
            
            log('\n=== SCAN COMPLETE ===\n');
        }

        // Check if browser supports Web Serial
        if (!('serial' in navigator)) {
            log('ERROR: Web Serial API not supported!', 'error');
            log('Please use Chrome or Edge browser', 'error');
        }
    </script>
</body>
</html>
